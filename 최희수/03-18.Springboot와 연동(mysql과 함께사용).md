# Springbootì™€ ì—°ë™(mysqlì™€ í•¨ê»˜ ì‚¬ìš©ì‹œ)




<br>
<br>
<br>

## ğŸŒˆ ì˜ˆì œì½”ë“œ 

> redis ìºì‹œë°ì´í„° ì €ì¥ì†Œë¥¼ ì´ìš©í•œ íšŒì› CRUD êµ¬í˜„.

<br>

### ğŸ³ ë²„ì ¼ & í™˜ê²½ì„¤ì •

<br>

* java - 11
* gradle
* springboot - 2.7.9
* dependencies
    - web, dev, lombok, jpa, mysql Driver
    - ì¶”ê°€(ë‚´ì¥ìºì‹œë¥¼ ìœ„í•´)
    ```yml
    // redis
     implementation 'org.springframework.boot:spring-boot-starter-data-redis'
    ```

<br>
<br>
<br>

### ğŸ³ entity

<br>

```java
package com.example.redis_mysql_test.entity;

import lombok.*;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;

@NoArgsConstructor
@AllArgsConstructor
@Entity
@Data
public class Student{

    private static final long serialVersionUID = 1L;

    @Id @GeneratedValue(strategy = GenerationType.AUTO)
    private Long id;
    private String username;
    private Integer age;

    @Builder
    public Student(String username, Integer age){
        this.username = username;
        this.age = age;
    }
}

```

<br>
<br>
<br>

### ğŸ³ dto

<br>

```java
package com.example.redis_mysql_test.dto;

import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
public class StudentDto {

    private String username;
    private Integer age;

    @Builder
    public StudentDto(String username, Integer age){
        this.username = username;
        this.age = age;
    }
}

```

<br>
<br>
<br>

### ğŸ³ controller

<br>

```java
package com.example.redis_mysql_test.controller;

import com.example.redis_mysql_test.dto.StudentDto;
import com.example.redis_mysql_test.entity.Student;
import com.example.redis_mysql_test.service.StudentService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@RestController
@Slf4j
public class StudentController {

    @Autowired
    StudentService studentService;
    // íšŒì› ë“±ë¡
    @PostMapping("/regist")
    public ResponseEntity<String> registStudent(@RequestBody StudentDto studentDto){
        log.info("íšŒì›ê°€ì…");
        studentService.saveStudent(studentDto);
        return new ResponseEntity<>("ì„±ê³µ", HttpStatus.OK);
    }


    // íšŒì› ê°œë³„ ì¡°íšŒ
    @GetMapping("/student/{studentId}")
    public ResponseEntity<StudentDto> findEachStudent(@PathVariable(name = "studentId") Long studentId) {
        log.info("ê° í•™ìƒ ì¡°íšŒ ì „");
        Student student = studentService.findStudentById(studentId);
        log.info("ê° í•™ìƒ ì¡°íšŒ í›„");
        StudentDto studentDto = StudentDto.builder()
                .username(student.getUsername())
                .age(student.getAge())
                .build();
        return new ResponseEntity<>(studentDto, HttpStatus.OK);
    }
    
    //íšŒì› ìˆ˜ì •
    @PutMapping("/update/{studentId}")
    public ResponseEntity<String> findAll(@PathVariable(name = "studentId") Long studentId,
                                                  @RequestBody StudentDto studentDto){
        log.info("í•™ìƒ ì •ë³´ ìˆ˜ì •");
        Student updatedStudent = studentService.updateStudent(studentId, studentDto);
        if(updatedStudent == null)
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("ìˆ˜ì • ì‹¤íŒ¨");
        return ResponseEntity.status(HttpStatus.OK).body("ìˆ˜ì • ì™„ë£Œ");
    }

    // íšŒì› ì‚­ì œ
    @DeleteMapping("/delete/{studentId}")
    public ResponseEntity<String> deleteStudent(@PathVariable(name = "studentId") Long studentId){
        Student deletedStudent = studentService.deleteStudent(studentId);
        if(deletedStudent == null)
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("ì‚­ì œ ì‹¤íŒ¨");
        return ResponseEntity.status(HttpStatus.OK).body("ì‚­ì œ ì„±ê³µ");
    }

}

```

<br>
<br>
<br>

### ğŸ³ service

<br>

```java
package com.example.redis_mysql_test.service;

import com.example.redis_mysql_test.dto.StudentDto;
import com.example.redis_mysql_test.entity.Student;
import com.example.redis_mysql_test.repository.StudentRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.cache.annotation.CacheEvict;
import org.springframework.cache.annotation.CachePut;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Optional;

@Service
@Slf4j
@RequiredArgsConstructor
public class StudentService {

    private final StudentRepository studentRepository;
    
    // ë“±ë¡
    @Transactional
    public Student saveStudent(StudentDto studentDto){
        Student newStudent = Student.builder()
                .username(studentDto.getUsername())
                .age(studentDto.getAge())
                .build();

        studentRepository.save(newStudent);
        log.info("íšŒì›ê°€ì… ì„œë¹„ìŠ¤");
        return newStudent;
    }

    // íšŒì› ì¡°íšŒ
    @Transactional(readOnly = true)
    @Cacheable("student")
    public Student findStudentById(Long studentId){
        log.info("íšŒì› ì•„ì´ë””ë¡œ ì¡°íšŒ ì„œë¹„ìŠ¤");
        Optional<Student> findedData = studentRepository.findById(studentId);
        if(!findedData.isPresent()){
            log.info("í•´ë‹¹í•˜ëŠ” í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.");
            return null;
        }
        Student findedStudent = findedData.get();
        log.info("service - í•´ë‹¹ í•™ìƒì€ : {}", findedStudent);
        return findedStudent;
    }

    // íšŒì› ìˆ˜ì •
    @Transactional
    @CachePut(value = "student", key="#studentId")
    public Student updateStudent(Long studentId, StudentDto studentDto){
        Optional<Student> findedStudent = studentRepository.findById(studentId);
        if(!findedStudent.isPresent()){
            log.info("í•´ë‹¹í•˜ëŠ” í•™ìƒì´ ì—†ìŒ");
            return null;
        }
        Student uStudent = findedStudent.get();
        uStudent.setUsername(studentDto.getUsername());
        uStudent.setAge(studentDto.getAge());
        return uStudent;
    }

    // íšŒì› ì‚­ì œ
    @Transactional
    @CacheEvict(value = "student", key = "#studentId")
    public Student deleteStudent(Long studentId){
        Optional<Student> findedStudent = studentRepository.findById(studentId);
        if(!findedStudent.isPresent()){
            log.info("í•´ë‹¹í•˜ëŠ” í•™ìƒ ì—†ìŒ");
            return null;
        }
        Student dStudent = findedStudent.get();
        studentRepository.delete(dStudent);
        log.info("ì •ìƒ ì‚­ì œë¨.");
        return dStudent;
    }
    
}

```

<br>
<br>
<br>

### ğŸ³ repository

<br>
* ë ˆë””ìŠ¤ë¥¼ ìœ„í•œ ë ˆí¬ì§€í† ë¦¬ 

```java
package com.example.redis_mysql_test.repository;

import com.example.redis_mysql_test.entity.Student;
import org.springframework.data.redis.repository.configuration.EnableRedisRepositories;
import org.springframework.data.repository.CrudRepository;

@EnableRedisRepositories
public interface StudentRedisRepository extends CrudRepository<Student, Long> {
}

```

* mysql(RDB)ë¥¼ ìœ„í•œ ë ˆí¬ì§€í† ë¦¬

```java
package com.example.redis_mysql_test.repository;

import com.example.redis_mysql_test.entity.Student;
import org.springframework.data.repository.CrudRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface StudentRepository extends CrudRepository<Student, Long>{
}

```

<br>
<br>
<br>

### ğŸ³ application.yml

<br>

```yml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/example
    username: root
    password: ssafy

  jpa:
    hibernate:
      ddl-auto: none
    properties:
      hibernate:
        format_sql: true
#        show-sql: true

  cache:
    type: redis
    redis:
      time-to-live: 60000
      cache-null-values: true
  redis:
    host: 127.0.0.1
    port: 6379

logging:
  level:
    org.hibernate.SQL: debug
```